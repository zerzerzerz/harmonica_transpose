# 口琴谱调号转换器 (Harmonica Transpoter)

这是一个用于口琴简谱调号转换的 Python 工具。它可以将一份以某个调（如 C 调）标记的谱子，转换为另一个调（如 D 调）的记谱方式，同时保持实际发音高度不变。

## 功能特点

- **多调性支持**：支持所有 12 个大调及其同音异名调号（C, Db/C#, D, Eb/D#, E, F, F#/Gb, G, Ab/G#, A, Bb/A#, B）。
- **符号解析**（采用全新的 Token 解析引擎，更加稳健）：
    - `#1` ~ `#7`：升半音。
    - `b1` / `♭1`：降半音。
    - `(1)` / `（1）`：低八度标记（支持中英文括号自动识别）。
    - `[1]` / `【1】`：高八度标记（支持中英文括号自动识别）。
- **智能重标记 (Re-labeling)**：核心逻辑是保持**实际物理音高不变**。例如 C 调的 `3` (E音)，在 D 调中会被重新标记为 `2` (D大调的第2级)。
- **文件输出**：支持将转换结果保存到指定文件。
- **异常字符预警**：自动识别谱子中无法解析为音符的字符并发出警告，支持将警告日志保存为文件。

## 安装

无需安装，只需确保您的系统中安装了 Python 3。

```bash
# 下载脚本后即可运行
python harmonica_transpose.py --help
```

## 使用方法

### 基础用法

将 C 调谱子转换为 D 调并在屏幕显示：

```bash
python harmonica_transpose.py -i input.txt --target D
```

### 保存到文件

使用 `-o` 参数指定输出文件：

```bash
python harmonica_transpose.py -i input.txt --target G -o output.txt
```

### 指定源调号

如果原始谱子不是 C 调（例如是 G 调谱）：

```bash
# 将 G 调谱子转换为 D 调表示
python harmonica_transpose.py -i input.txt --target D --source G
```

### 记录警告信息

将无法识别的字符记录到日志文件中：

```bash
python harmonica_transpose.py -i input.txt --target D -w warnings.log
```

### 参数说明

| 参数         | 缩写 | 描述         | 备注                                   |
| :----------- | :--- | :----------- | :------------------------------------- |
| `--input`    | `-i` | 输入内容     | 可以是文件路径，也可以是单纯的谱子文本 |
| `--target`   |      | 目标调号     | 如 D, F#, Bb (必填)                    |
| `--source`   | `-s` | 源调号       | 默认为 C                               |
| `--output`   | `-o` | 输出文件路径 | 若不指定则打印到屏幕                   |
| `--warnings` | `-w` | 警告日志路径 | 记录无法解析的字符及其编码             |

## 示例

**输入 (C 调):**
`332#4 (6)2335#4`

**命令:**
`python harmonica_transpose.py -i "332#4 (6)2335#4" --target D`

**输出 (D 调):**
`2213 (5)12243`

> **提示**：仓库中附带的 `input` 和 `output` 文件包含了一个完整的示例曲目（天空之城），您可以直接运行测试。

## 如何选择目标调号？

如果你的简谱是基于 1=C 记录的，但其中包含大量的临时升降号（如 `#1`, `#4` 等），这通常说明该曲子原本可能属于另一个调。

你可以使用以下 **AI Prompt** 辅助你分析最合适的记谱调号：

```markdown
# Role
你是一位精通乐理的音乐分析师。请协助我分析一段基于 **1=C** 记谱的简谱，找出它原本最合适的调性（Key）。

# Context & Goal
这段简谱目前是用 1=C 记录的，因此谱面上可能包含大量的临时升降号（如 #1, #4 等）。
你需要通过分析这些音符的实际音高，推断出用哪个调（例如 1=D, 1=A 等）来记谱可以消除这些升降号，使谱面最简洁、最符合调性逻辑。

# Input Notation Rules
请按以下规则理解我输入的符号：
- **基准**：输入默认为 1=C。
- **音符**：1-7 代表 Do-Ti，# 表示升号，b 表示降号。
- **八度**：( ) 代表低八度，【 】或 [ ] 代表高八度。
- **结构**：数字间的空格或换行代表乐句的自然分隔。

# Analysis Steps (请在回复中展示你的思考过程)
建议按照以下逻辑进行分析，并写出你的推理步骤：
1. **音高还原**：浏览谱面，找出所有出现的不同音符（特别是带升降号的），将它们转化为具体的音名（如 C, C#, D, F# 等）。
2. **音阶匹配**：观察这些音名构成了什么音阶？是否存在某一个大调（Major Scale），其自然音阶正好包含这些音符？
   - *提示*：例如，如果谱面上反复出现 #1 (C#), #4 (F#), #5 (G#)，这通常指向 A 大调。
3. **调性验证**：检查旋律的主音（结尾音）或核心和弦，确认你的推断是否符合乐理逻辑。

# Output Format
请首先输出你的**分析思考过程**，最后给出一个明确的结论。格式如下：

### 1. 乐理分析
(请在此处写下你对音高、音阶和调性的分析过程)

### 2. 结论
* **建议记谱调号**：1 = [你的答案]
* **理由简述**：[一句话概括，例如：原谱的 #4 和 #1 在该调中正好是 naturally occurring 的 3 和 7]

---
# User Input:
```

## 注意事项

- 程序采用递归解析，支持括号嵌套。
- 空格、换行以及 `0`, `8`, `9`, `=`, `-`, `|` 等常用乐谱辅助符号默认会被保留且不触发警告。
- 建议使用标准 UTF-8 编码的文件。
